@using BanDoMba.EF
@{
    ViewData["Title"] = "Home Page";
}
@model IEnumerable<DeviceLocation>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
@* <link href="~/css/leaflet.css" rel="stylesheet" /> *@
@* <link href="~/css/leaflet-routing-machine.css" rel="stylesheet" /> *@
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
<div class="text-center">
    <div id="map" style="height: 90vh; width: 90vw;"></div>
</div>
@section Scripts {
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script>
        $(document).ready(function () {

            async function checkLocationPermission() {
                try {
                    const status = await navigator.permissions.query({ name: 'geolocation' });

                    if (status.state === 'granted') {
                        console.log("Permission already granted. Accessing location...");
                        getLocation();
                    } else if (status.state === 'prompt') {
                        console.log("User hasn't decided yet. Prompt will show now.");
                        getLocation();
                    } else {
                        console.log("Permission denied. You might need to guide the user to browser settings.");
                    }

                    // Listen for changes (e.g., if the user goes into settings and flips a switch)
                    status.onchange = () => {
                        console.log("Permission state changed to: ", status.state);
                    };
                } catch (error) {
                    console.log("Permissions API not supported in this browser.");
                }
            }

            checkLocationPermission();
            var routingControl = null;

            // Define your custom Red Icon
            var redIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            function drawRoute(destLat, destLng, destName) {
                if (!userLocation) {
                    alert("Current location not found yet.");
                    return;
                }
                    // Remove existing route if it exists
                if (routingControl) {
                    map.removeControl(routingControl);
                }
                   // Create the routing control and add it to the map
                routingControl = L.Routing.control({
                    waypoints: [
                        L.latLng(userLocation.lat, userLocation.lng), // Start: User
                        L.latLng(destLat, destLng)                   // End: Marker
                    ],
                    // --- CUSTOM MARKER LOGIC ---
                    createMarker: function(i, waypoint, n) {
                        var markerOptions = {
                            draggable: false,
                        };

                        // i === 0 is the starting point (Your location)
                        if (i === 0) {
                            markerOptions.icon = redIcon;
                        }

                        return L.marker(waypoint.latLng, markerOptions)
                            .bindPopup(i === 0 ? "Bạn đang ở đây" : `Thông số:${destName}`);
                    },
                    lineOptions: {
                        styles: [{ color: 'blue', opacity: 0.6, weight: 6 }]
                    },
                    routeWhileDragging: false,
                    addWaypoints: false, // Prevent users from adding dots on the line
                    draggableWaypoints: false,
                    fitSelectedRoutes: true,
                    show: false // Set to true if you want a text-based turn-by-turn box
                }).addTo(map);
            }

            // Initialize the map
            var map = L.map('map').setView([0, 0], 2);
            var userLocation = null;
            

             // Add the OpenStreetMap Tile Layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
           
            // Locate the user
            map.locate({setView: true, maxZoom: 16});

            // Convert C# Model to JavaScript JSON
            var locations = @Html.Raw(Json.Serialize(Model))

            map.on('locationfound', function(e) {
               userLocation = e.latlng;

               // Loop through the data and add markers
               locations.forEach(function (loc) {
                   var marker = L.marker([loc.longitude, loc.latitude]).addTo(map);

                   // Bind dynamic popup information
                   marker.bindPopup(`
                       <div style="text-align:center;">
                           <h5 style="margin:0;">${loc.tenTram}</h5>
                           <p style="font-size:12px;">${loc.moTa}</p>
                       </div>
                   `);

                   drawRoute(loc.latitude, loc.longitude, loc.tenTram);
               });
            });

            map.on('locationerror', function(e) {
                console.log("Location access denied.");

                // Loop through the data and add markers
                locations.forEach(function (loc) {
                    var marker = L.marker([loc.lat, loc.lng]).addTo(map);

                    // Bind dynamic popup information
                    marker.bindPopup(`
                        <div style="text-align:center;">
                            <h5 style="margin:0;">${loc.name}</h5>
                            <p style="font-size:12px;">${loc.description}</p>
                            <button class="btn btn-sm btn-info" onclick="alert('Viewing ${loc.name}')">Details</button>
                        </div>
                    `);

                     //Draw Polyline on Popup Open or Button Click
                    marker.on('popupopen', function() {
                        // Optional: Draw automatically, or wait for button click inside popup
                        $('.draw-line-btn').on('click', function() {
                            drawRoute(loc.lat, loc.lng);
                        });
                    });
                });

            });
        });
    </script>
}